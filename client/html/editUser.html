<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHAI MEAOW</title>

    <link href="https://fonts.googleapis.com/css2?family=Paytone+One&family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/editUser.css">
    <link rel="icon" type="image/png" href="/img/logokhaimeaow.svg">
</head>

<body>
    <header class="navbar">
        <div class="logo">
            <a href="/admin"><img src="/img/logokhaimeaow.svg"></a>
        </div>
        <nav>
            <ul>
                <li><a href="/admin/manageProduct">Product</a></li>
                <li class="clickcomplete"><a href="/admin/manageUser">User</a></li>
                <li><button id="logout"><img src="/img/icon-logout.png"></button></li>
            </ul>
        </nav>
    </header>

<div class="ellipse"></div>

<div class="bgContainer">
    <div class="pageBox">

        <h1 class="title">Edit User</h1>

        <form id="editUserForm" class="formBox">

            <div class="formRow">
                <label class="formLabel"></label>
                <span id="adminIDLabel" class="formValue"></span>
            </div>

            <label class="formLabel" for="Admin_Firstname">ชื่อ</label>
            <input class="formInput" type="text" id="Admin_Firstname" name="Admin_Firstname" placeholder="ชื่อ">

            <label class="formLabel" for="Admin_Lastname">นามสกุล</label>
            <input class="formInput" type="text" id="Admin_Lastname" name="Admin_Lastname" placeholder="นามสกุล">

            <label class="formLabel" for="Admin_Email">Email</label>
            <input class="formInput" type="email" id="Admin_Email" name="Admin_Email" placeholder="Email">

            <label class="formLabel" for="Admin_Phone">เบอร์โทรศัพท์</label>
            <input class="formInput" type="tel" id="Admin_Phone" name="Admin_Phone" placeholder="เบอร์โทรศัพท์" pattern="0[0-9]{9}" title="0XXXXXXXXX">

            <h3 class="subTitle">กำหนดรหัสผ่าน</h3>

            <label class="formLabel" for="Admin_Password">Password</label>
            <input class="formInput" type="password" id="Admin_Password" name="Admin_Password" placeholder="Password">

            <label class="formLabel" for="Admin_Password_Confirm">Confirm Password</label>
            <input class="formInput" type="password" id="Admin_Password_Confirm" name="Admin_Password_Confirm" placeholder="Confirm Password">

            <div class="btnRow">
                <button type="button" class="deleteBtn" id="deleteBtn">Remove</button>
                <button type="button" class="cancelBtn" onclick="window.location.href='/admin/manageUser'">Cancel</button>
                <button type="submit" class="submitBtn">Confirm</button>
            </div>

        </form>

    </div>
</div>

 
    <script>

        fetch('http://localhost:8080/check-auth', { 
            credentials: 'include' 
        }).then(res => {
            if (!res.ok) throw new Error('Not Authorized');
            return res.json();
        }).then(data => {
            console.log("Authorized as:", data.user.email);
        }).catch(() => {
            window.location.href = 'http://localhost:3030/acc'; 
        });

        const urlParams = new URLSearchParams(window.location.search)
        const adminID = urlParams.get('id');
        const form = document.getElementById('editUserForm')

        const adminIDLabel = document.getElementById('adminIDLabel');
        adminIDLabel.textContent = `Admin ID: ${adminID}`
            
        form.addEventListener('submit', async e => {
            e.preventDefault();
            try{
                const  formData = new FormData();

                // update some
                if (form.Admin_Firstname.value) formData.append("Admin_Firstname", form.Admin_Firstname.value);
                if (form.Admin_Lastname.value) formData.append("Admin_Lastname",form.Admin_Lastname.value);
                if (form.Admin_Phone.value) formData.append("Admin_Phone",form.Admin_Phone.value);
                if (form.Admin_Email.value) formData.append("Admin_Email",form.Admin_Email.value);

                const password = document.getElementById('Admin_Password').value;
                const confirmPasswd = document.getElementById('Admin_Password_Confirm').value;

                if (password != confirmPasswd) {
                    alert('Passwords do NOT MATCH! Please try again.')
                    return;
                } else {
                    if (form.Admin_Password.value) formData.append("Admin_Password",form.Admin_Password.value);
                }

                const putRes = await fetch(`http://localhost:8080/api/users/${adminID}`, {
                    method : 'PUT',
                    body : formData,
                    credentials: 'include'
                });

                if (putRes.status === 401 || putRes.status === 403){
                    window.location = 'http://localhost:3030/acc';
                    return;
                }

                const data = await putRes.json();
                alert(data.message);
                window.location.href = '/admin/manageUser';
                
            } catch (err) {
            console.error('Error editing user:', err);
            alert('ERROR: ' + err.message);
            }
        });

        
        
        
        
        document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm('Confirm delete?')) return;
            
            try {
                const delRes = await fetch(`http://localhost:8080/api/users/${adminID}`, {
                    method : 'DELETE',
                    credentials: 'include'
                });

                if (delRes.status === 401 || delRes.status === 403){
                    window.location = 'http://localhost:3030/acc';
                    return;
                }
                
                if (!delRes.ok) throw new Error('Failed to delete');

                const data = await delRes.json();
                alert(data.message);
                window.location.href = '/admin/manageUser';
            
            } catch (err) {
                console.error('Error deleting user:', err);
                alert('ERROR: ' + err.message);
            }
        });

        document.getElementById('logout').addEventListener('click', async() => {
            const res = await fetch ('http://localhost:8080/logout', {
                method: 'POST',
                credentials: 'include'
            });

            if (res.status === 200){
                window.location.href = 'http://localhost:3030/acc';
            }
        });

    </script>
   

});


</body>

</html>
